version: 2.1
anchors: &tag-filter {filters: {tags: {only: /.*/}}}
orbs:
  github-release: h-matsuo/github-release@0.1.3
commands:
  deps:
    steps:
      - run: sudo apt-get update; sudo apt-get install -y pv pbzip2 mecab
      - run: pip install -r requirements.txt
  compute-freqs:
    parameters:
      lang:
        type: string
    steps:
      - run: ./compute-freqs.sh <<parameters.lang>> download
      - run: ./compute-freqs.sh <<parameters.lang>> bunzip
      - run: ./compute-freqs.sh <<parameters.lang>> extract
      - run: ./compute-freqs.sh <<parameters.lang>> compute
      - persist_to_workspace:
          root: out
          paths:
            - "*.zip*"
jobs:
  ja:
    docker:
      - image: circleci/python:3.8.5
    steps:
      - checkout
      - deps
      - run: python -m unidic download 1.0.2
      - compute-freqs:
          lang: ja
  vi:
    docker:
      - image: circleci/python:3.8.5
    steps:
      - checkout
      - deps
      - compute-freqs:
          lang: vi
  sg:
    docker:
      - image: circleci/python:3.8.5
    steps:
      - checkout
      - deps
      - compute-freqs:
          lang: sg
  gh-release:
    docker:
      - image: cimg/base:2020.01
    steps:
      - checkout
      - attach_workspace:
          at: out
      - github-release/create:
          tag: $CIRCLE_TAG
          title: Version $CIRCLE_TAG
          description: This release is version $CIRCLE_TAG.
          file-path: out
workflows:
  release:
    jobs:
      - sg:
          <<: *tag-filter
      - gh-release:
          <<: *tag-filter
          requires:
            - sg
